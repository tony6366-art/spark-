# Spark 기반 보안 로그 이상 탐지

이 저장소는 Apache Spark를 이용해서 보안 로그에서 이상 징후를 찾아내는 실험 프로젝트입니다. 실제 서비스 로그를 그대로 쓰기보다는, 먼저 방화벽·웹서버 로그와 비슷한 형태의 데이터를 직접 만들어 내고, 그 데이터를 Spark ML 파이프라인에 태워서 “정상 패턴과 거리가 먼 이벤트”를 골라내는 흐름을 구현했습니다. 한 줄로 요약하면, **보안 로그를 빅데이터 엔진 위에서 다루면서 비지도 학습 기반 이상 탐지를 끝까지 한 번 구현해 본 코드**입니다.

로그 생성 단계에서는 `generate_logs()` 함수로 `timestamp, src_ip, dst_ip, src_port, dst_port, protocol, action, bytes, resp_code` 같은 필드를 가진 CSV를 만듭니다. 내부 IP 대역(예: `10.0.0.x`)에서 외부 IP로 나가는 트래픽을 흉내 내고, 웹/SSH/DB 포트 쪽으로 약간 편향을 줘서 “조금은 수상한 움직임이 섞여 있는 트래픽”이 되도록 구성했습니다. 이 데이터는 기본적으로 `/content/security_logs.csv`로 떨어지게 되어 있고, Colab 환경에서 바로 다음 단계로 이어서 사용할 수 있습니다.

Spark 쪽에서는 먼저 명시적인 스키마를 정의한 뒤, 생성한 CSV를 DataFrame으로 읽어 옵니다. `timestamp` 컬럼은 Spark의 `timestamp` 타입으로 파싱해서 `hour`, `day_of_week` 같은 시간 파생 변수를 추가로 만들고, 이후 특징(feature)로 활용합니다. 범주형 변수인 `protocol`과 `action`은 `StringIndexer`와 `OneHotEncoder`로 숫자 벡터로 바꾸고, 포트, 바이트 수, 응답 코드, 시간 정보 등과 함께 `VectorAssembler`로 하나의 feature 벡터로 묶습니다. 마지막으로 `StandardScaler`로 평균 0, 분산 1 기준으로 스케일링해서 K-Means가 잘 수렴하도록 했습니다. 이 전처리 과정은 하나의 `Pipeline`으로 묶어 두어서, 나중에 새로운 로그에도 같은 방식으로 쉽게 적용할 수 있습니다.

이상 탐지 자체는 Spark MLlib의 `KMeans`를 사용합니다. 클러스터 개수 `k=10`을 주고 학습을 돌리면, 각 로그는 어느 클러스터에 속하는지(`cluster`)와 변환된 feature 벡터를 갖게 됩니다. 여기서 한 번 더, 각 포인트가 속한 클러스터 중심으로부터 얼마나 떨어져 있는지 제곱거리(`distance`)를 직접 계산해서 컬럼으로 추가했습니다. 직관적으로, 클러스터 중심에서 멀리 떨어진 로그일수록 “평소 패턴과 다른 행동을 한 이벤트”로 볼 수 있기 때문에 이상치 후보가 됩니다.

마지막 단계에서는 이 distance 값을 기준으로 상위 1% 구간에 해당하는 임계값을 `approxQuantile`로 구하고, 그 기준을 넘는 로그만 필터링해서 이상 로그로 간주합니다. 이렇게 걸러진 레코드는 타임스탬프, IP 정보, 포트, 프로토콜, 액션, 응답 코드, 클러스터 번호와 거리까지 함께 출력해서, “어떤 요청이 왜 수상해 보이는지”를 눈으로 바로 확인할 수 있게 했습니다. 학습에 사용된 전처리 파이프라인과 K-Means 모델은 `/content/preprocess_model`, `/content/kmeans_model` 경로에 저장하도록 해 두었기 때문에, 추후에 스트리밍 파이프라인이나 다른 로그 샘플에 그대로 재사용하는 것도 염두에 두고 설계했습니다.

개발·실행 환경은 Google Colab을 기준으로 했고, `pyspark==3.5.0` 버전을 사용했습니다. 노트북 상단에서 PySpark를 설치하고 SparkSession만 생성해 주면 나머지 코드는 그대로 실행되도록 구성해 두었습니다. 전체적으로는 “보안 로그를 데이터로 보고, Spark를 이용해 전처리 → 특징 추출 → 비지도 학습 → 이상치 스코어링까지 한 번에 흐름을 만든 프로젝트”로, 이후에 Threat Intelligence 연동, Kafka 스트림 처리, ELK 대시보드 같은 요소를 더 얹어서 확장할 수 있는 기반이 됩니다.
